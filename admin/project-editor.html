<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DK设计师作品集 - 项目编辑器</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <!-- TinyMCE富文本编辑器 -->
    <script src="https://cdn.tiny.cloud/1/7xmet4ptzimn3bldsl5x0vog9vueakrcg6vu836cuulwpthn/tinymce/6/tinymce.min.js" referrerpolicy="origin"></script>
    <style>
        body {
            background-color: #f9fafb;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        }
        
        .tox-tinymce {
            border-radius: 0.375rem;
            border-color: #e5e7eb;
        }
        
        .image-preview {
            max-width: 100%;
            max-height: 200px;
            object-fit: contain;
        }

        /* 添加自定义样式，去除编辑器中图片间的留白 */
        .mce-content-body img {
            margin: 0 !important;
            padding: 0 !important;
            display: inline-block !important;
            vertical-align: top !important;
        }
        
        .mce-content-body p {
            margin: 0 !important;
            padding: 0 !important;
            line-height: 0 !important;
            font-size: 0 !important;
        }
        
        /* 确保在内容预览时也移除图片间距 */
        #tinymce img {
            margin: 0 !important;
            padding: 0 !important;
            display: inline-block !important;
            vertical-align: top !important;
        }
        
        #tinymce p {
            margin: 0 !important;
            padding: 0 !important;
            line-height: 0 !important;
            font-size: 0 !important;
        }
    </style>
</head>
<body class="bg-gray-50">
    <div class="min-h-screen flex flex-col">
        <!-- 导航栏 -->
        <nav class="bg-white shadow-sm">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between h-16">
                    <div class="flex">
                        <div class="flex-shrink-0 flex items-center">
                            <h1 class="text-lg font-bold">DK设计师作品集管理系统</h1>
                        </div>
                    </div>
                    <div class="flex items-center">
                        <a href="dashboard.html" class="mr-4 px-3 py-1 border border-transparent text-sm font-medium rounded-md text-gray-700 hover:bg-gray-100 focus:outline-none">
                            返回仪表盘
                        </a>
                        <button id="logoutBtn" class="px-3 py-1 border border-transparent text-sm font-medium rounded-md text-indigo-700 bg-indigo-100 hover:bg-indigo-200 focus:outline-none">
                            退出登录
                        </button>
                    </div>
                </div>
            </div>
        </nav>

        <!-- 主内容区 -->
        <main class="flex-1">
            <div class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
                <!-- 页面标题 -->
                <div class="pb-5 border-b border-gray-200">
                    <h3 class="text-lg leading-6 font-medium text-gray-900" id="pageTitle">
                        添加新作品
                    </h3>
                </div>

                <!-- 项目编辑表单 -->
                <div class="mt-8">
                    <form id="projectForm" class="space-y-8">
                        <input type="hidden" id="projectId" value="">
                        
                        <!-- 基本信息 -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="col-span-1">
                                <label for="title" class="block text-sm font-medium text-gray-700">作品标题</label>
                                <input type="text" name="title" id="title" required class="mt-1 focus:ring-indigo-500 focus:border-indigo-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md">
                            </div>
                            
                            <div class="col-span-1">
                                <label for="category" class="block text-sm font-medium text-gray-700">类别</label>
                                <select id="category" name="category" class="mt-1 block w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                                    <option value="UI/UX设计">UI/UX设计</option>
                                    <option value="品牌设计">品牌设计</option>
                                    <option value="平面设计">平面设计</option>
                                    <option value="网站设计">网站设计</option>
                                    <option value="插画设计">插画设计</option>
                                </select>
                            </div>
                            
                            <div class="col-span-1">
                                <label for="date" class="block text-sm font-medium text-gray-700">日期</label>
                                <input type="text" name="date" id="date" class="mt-1 focus:ring-indigo-500 focus:border-indigo-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md" placeholder="例如：2023年5月">
                            </div>
                            
                            <div class="col-span-1">
                                <label for="client" class="block text-sm font-medium text-gray-700">客户</label>
                                <input type="text" name="client" id="client" class="mt-1 focus:ring-indigo-500 focus:border-indigo-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md">
                            </div>
                        </div>
                        
                        <!-- 封面图片 -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700">作品封面图</label>
                            <div class="mt-2 flex flex-col items-start">
                                <div id="coverPreviewContainer" class="mb-3 hidden">
                                    <img id="coverPreview" src="" alt="封面预览" class="image-preview">
                                </div>
                                <div class="flex items-center">
                                    <input type="text" id="coverUrl" name="coverUrl" placeholder="图片URL" class="focus:ring-indigo-500 focus:border-indigo-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md">
                                    <button type="button" id="previewCoverBtn" class="ml-3 inline-flex items-center px-3 py-2 border border-transparent text-sm leading-4 font-medium rounded-md text-indigo-700 bg-indigo-100 hover:bg-indigo-200 focus:outline-none">
                                        预览
                                    </button>
                                </div>
                                <p class="mt-1 text-xs text-gray-500">输入图片URL或使用Unsplash等图库的图片链接</p>
                            </div>
                        </div>
                        
                        <!-- 富文本编辑器 -->
                        <div>
                            <label for="content" class="block text-sm font-medium text-gray-700">作品详情</label>
                            <div class="mt-1">
                                <textarea id="content" name="content" rows="20"></textarea>
                            </div>
                        </div>
                        
                        <!-- 提交按钮 -->
                        <div class="flex justify-end">
                            <button type="button" id="cancelBtn" class="mr-3 inline-flex justify-center py-2 px-4 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none">
                                取消
                            </button>
                            <button type="submit" class="inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none">
                                保存作品
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </main>
    </div>

    <script>
        // 检查登录状态
        if (!localStorage.getItem('isLoggedIn')) {
            window.location.href = 'index.html';
        }
        
        // 退出登录
        document.getElementById('logoutBtn').addEventListener('click', function() {
            localStorage.removeItem('isLoggedIn');
            window.location.href = 'index.html';
        });
        
        // 取消按钮
        document.getElementById('cancelBtn').addEventListener('click', function() {
            window.location.href = 'dashboard.html';
        });
        
        // 初始化TinyMCE编辑器
        tinymce.init({
            selector: '#content',
            plugins: 'image link lists table code',
            toolbar: 'undo redo | formatselect | bold italic | alignleft aligncenter alignright | bullist numlist | link image | table | code',
            height: 500,
            menubar: true,
            // 完全禁用域验证
            browser_spellcheck: false,
            verify_html: false,
            forced_root_block: false,
            relative_urls: false,
            remove_script_host: false,
            document_base_url: '/',
            referrer_policy: 'origin',
            convert_urls: false,
            skin: 'oxide',
            content_css_cors: true,
            language: 'zh_CN',
            // 允许任何域
            trusted_domains: '*',
            images_upload_handler: function (blobInfo, success, failure) {
                // 这里可以实现图片上传功能，但在这个简化版中，我们只支持URL图片
                failure('请使用图片URL');
            },
            // 添加自定义CSS到编辑器内容区域
            content_style: `
                img { margin: 0 !important; padding: 0 !important; display: inline-block !important; vertical-align: top !important; }
                p { margin: 0 !important; padding: 0 !important; line-height: 0 !important; }
                figure { margin: 0 !important; padding: 0 !important; }
                figure.image { margin: 0 !important; padding: 0 !important; display: inline-block !important; }
            `,
            // 处理图片粘贴事件
            paste_postprocess: function(plugin, args) {
                // 移除所有图片周围的空白
                if (args.content) {
                    args.content = args.content.replace(/<p>\s*<img/g, '<p><img');
                    args.content = args.content.replace(/<img\s+([^>]*)>\s*<\/p>/g, '<img $1></p>');
                }
            },
            // 自定义图片初始化
            setup: function(editor) {
                editor.on('NodeChange', function(e) {
                    // 确保所有图片没有间距
                    if (e.element.nodeName === 'IMG') {
                        e.element.style.margin = '0';
                        e.element.style.padding = '0';
                        e.element.style.display = 'inline-block';
                        e.element.style.verticalAlign = 'top';
                        
                        // 如果图片在段落中，确保段落没有间距
                        if (e.element.parentNode && e.element.parentNode.nodeName === 'P') {
                            e.element.parentNode.style.margin = '0';
                            e.element.parentNode.style.padding = '0';
                            e.element.parentNode.style.lineHeight = '0';
                        }
                    }
                });
            }
        });
        
        // 预览封面图
        document.getElementById('previewCoverBtn').addEventListener('click', function() {
            const coverUrl = document.getElementById('coverUrl').value;
            if (coverUrl) {
                const coverPreview = document.getElementById('coverPreview');
                const previewContainer = document.getElementById('coverPreviewContainer');
                
                coverPreview.src = coverUrl;
                coverPreview.onload = function() {
                    previewContainer.classList.remove('hidden');
                };
                coverPreview.onerror = function() {
                    alert('图片加载失败，请检查URL是否正确');
                    previewContainer.classList.add('hidden');
                };
            }
        });
        
        // 获取URL参数
        function getUrlParam(param) {
            const queryString = window.location.search;
            const urlParams = new URLSearchParams(queryString);
            return urlParams.get(param);
        }
        
        // 加载项目数据（如果是编辑模式）
        document.addEventListener('DOMContentLoaded', async function() {
            const projectId = getUrlParam('id');
            
            if (projectId) {
                // 编辑模式
                document.getElementById('pageTitle').textContent = '编辑作品';
                document.getElementById('projectId').value = projectId;
                
                try {
                    // 从本地存储获取项目数据
                    let projects = [];
                    const storedProjects = localStorage.getItem('projects');
                    if (storedProjects) {
                        projects = JSON.parse(storedProjects);
                    }
                    
                    // 查找当前项目
                    const project = projects.find(p => p.id === projectId);
                    
                    if (project) {
                        // 填充表单数据
                        document.getElementById('title').value = project.title || '';
                        document.getElementById('category').value = project.category || '';
                        document.getElementById('date').value = project.date || '';
                        document.getElementById('client').value = project.client || '';
                        document.getElementById('coverUrl').value = project.cover || '';
                        
                        // 预览封面图
                        if (project.cover) {
                            const coverPreview = document.getElementById('coverPreview');
                            const previewContainer = document.getElementById('coverPreviewContainer');
                            
                            coverPreview.src = project.cover;
                            previewContainer.classList.remove('hidden');
                        }
                        
                        // 设置编辑器内容
                        // 注意：需要在TinyMCE初始化完成后设置
                        if (tinymce.get('content')) {
                            tinymce.get('content').setContent(project.content || '');
                        } else {
                            tinymce.on('init', function() {
                                tinymce.get('content').setContent(project.content || '');
                            });
                        }
                    } else {
                        alert('找不到指定项目');
                        window.location.href = 'dashboard.html';
                    }
                } catch (error) {
                    console.error('加载项目数据失败:', error);
                    alert('无法加载项目数据: ' + error.message);
                }
            }
        });
        
        // 表单提交
        document.getElementById('projectForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // 获取表单数据
            const projectId = document.getElementById('projectId').value || String(Date.now());
            const title = document.getElementById('title').value;
            const category = document.getElementById('category').value;
            const date = document.getElementById('date').value;
            const client = document.getElementById('client').value;
            const cover = document.getElementById('coverUrl').value;
            const content = tinymce.get('content').getContent();
            
            // 验证必填字段
            if (!title || !cover) {
                alert('请填写必填项：作品标题和封面图');
                return;
            }
            
            // 准备项目数据
            const projectData = {
                id: projectId,
                title,
                category,
                date,
                client,
                cover,
                content,
                updatedAt: new Date().toISOString()
            };
            
            try {
                // 获取现有项目数据
                let projects = [];
                try {
                    const storedProjects = localStorage.getItem('projects');
                    if (storedProjects) {
                        projects = JSON.parse(storedProjects);
                    }
                } catch (e) {
                    console.error('解析本地存储数据失败:', e);
                    projects = [];
                }
                
                if (!Array.isArray(projects)) {
                    projects = [];
                }
                
                // 检查是更新还是新增
                const existingIndex = projects.findIndex(p => p.id === projectId);
                
                if (existingIndex >= 0) {
                    // 更新现有项目
                    projects[existingIndex] = {
                        ...projects[existingIndex],
                        ...projectData
                    };
                } else {
                    // 添加创建时间
                    projectData.createdAt = new Date().toISOString();
                    // 新增项目
                    projects.push(projectData);
                }
                
                // 保存到本地存储
                localStorage.setItem('projects', JSON.stringify(projects));
                
                // 为前端展示也保存一份到模拟的API文件
                try {
                    // 在本地存储中保存一份模拟的JSON文件数据
                    localStorage.setItem('apiProjects', JSON.stringify(projects));
                } catch (e) {
                    console.error('保存API数据失败:', e);
                }
                
                // 提示用户
                alert('作品已成功保存');
                
                // 返回仪表盘
                window.location.href = 'dashboard.html';
            } catch (error) {
                console.error('保存数据失败:', error);
                alert('保存失败: ' + error.message);
            }
        });
    </script>
</body>
</html> 